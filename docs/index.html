<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cane Toad Detector</title>

  <!-- ONNX Runtime Web — runs the YOLOv8 model in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.3/dist/ort.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #0f1117;
      color: #e0e0e0;
      font-family: 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #1a1d27;
      border-bottom: 2px solid #00dc5a;
      padding: 14px 28px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header .dot {
      width: 12px; height: 12px; border-radius: 50%;
      background: #00dc5a;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
    header h1  { font-size: 1.2rem; font-weight: 600; }
    header .sub { margin-left: auto; font-size: 0.78rem; color: #555; }

    .main { display: flex; flex: 1; overflow: hidden; }

    /* ---- Video panel ---- */
    .video-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      gap: 14px;
    }

    .video-wrap {
      position: relative;
      border: 2px solid #2a2d3a;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 32px rgba(0,220,90,.08);
    }

    #video {
      display: block;
      width: 640px;
      max-width: 100%;
      height: auto;
      background: #000;
    }

    /* Canvas sits exactly on top of the video */
    #canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }

    .video-hint { font-size: 0.75rem; color: #555; }

    /* ---- Status bar below video ---- */
    .status-bar {
      display: flex;
      gap: 24px;
      background: #1a1d27;
      border: 1px solid #2a2d3a;
      border-radius: 6px;
      padding: 8px 18px;
      font-size: 0.8rem;
      color: #888;
      width: 640px;
      max-width: 100%;
    }
    .status-bar span { color: #00dc5a; font-weight: 600; }

    /* ---- Sidebar ---- */
    .sidebar {
      width: 280px;
      background: #1a1d27;
      border-left: 1px solid #2a2d3a;
      display: flex;
      flex-direction: column;
      padding: 20px 16px;
      gap: 16px;
      overflow-y: auto;
    }
    .sidebar h2 {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #666;
      border-bottom: 1px solid #2a2d3a;
      padding-bottom: 8px;
    }

    #det-count {
      font-size: 2.4rem;
      font-weight: 700;
      color: #00dc5a;
      line-height: 1;
    }
    #det-count small {
      display: block;
      font-size: 0.75rem;
      color: #555;
      font-weight: 400;
      margin-top: 4px;
    }

    #det-list { display: flex; flex-direction: column; gap: 8px; }

    .det-card {
      background: #12151e;
      border: 1px solid #2a2d3a;
      border-left: 3px solid #00dc5a;
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 0.82rem;
    }
    .det-card .lbl  { font-weight: 600; color: #00dc5a; text-transform: capitalize; margin-bottom: 3px; }
    .det-card .conf { color: #aaa; }
    .det-card .bar-bg  { background: #2a2d3a; border-radius: 3px; height: 4px; margin-top: 5px; }
    .det-card .bar-fill{ height: 100%; background: #00dc5a; border-radius: 3px; transition: width .2s; }
    .det-card .bbox { color: #444; font-size: 0.7rem; margin-top: 4px; }

    .none-msg { color: #444; font-size: 0.82rem; text-align: center; }

    /* ---- Loading overlay ---- */
    #overlay {
      position: fixed; inset: 0;
      background: rgba(15,17,23,.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 18px;
      z-index: 100;
    }
    #overlay.hidden { display: none; }
    .spinner {
      width: 48px; height: 48px;
      border: 4px solid #2a2d3a;
      border-top-color: #00dc5a;
      border-radius: 50%;
      animation: spin .9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #overlay p   { color: #aaa; font-size: 0.95rem; }
    #overlay .err{ color: #ff5c5c; font-size: 0.9rem; max-width: 380px; text-align: center; }

    footer {
      background: #1a1d27;
      border-top: 1px solid #2a2d3a;
      padding: 8px 24px;
      font-size: 0.7rem;
      color: #333;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- Loading / error overlay -->
<div id="overlay">
  <div class="spinner"></div>
  <p id="overlay-msg">Loading model...</p>
  <p id="overlay-err" class="err"></p>
</div>

<header>
  <div class="dot"></div>
  <h1>Cane Toad Detector</h1>
  <span class="sub">YOLOv8 &nbsp;·&nbsp; Browser Inference &nbsp;·&nbsp; Live Webcam</span>
</header>

<div class="main">

  <div class="video-panel">
    <div class="video-wrap">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="status-bar">
      <div>FPS &nbsp;<span id="fps-val">--</span></div>
      <div>Detections &nbsp;<span id="det-val">0</span></div>
      <div>Confidence &nbsp;<span id="conf-val">≥ 50%</span></div>
    </div>

    <p class="video-hint">Webcam access required &nbsp;·&nbsp; Inference runs locally in your browser</p>
  </div>

  <div class="sidebar">
    <h2>Live Detections</h2>
    <div>
      <div id="det-count">0 <small>detected this frame</small></div>
    </div>
    <div id="det-list">
      <p class="none-msg">Waiting for detections...</p>
    </div>
  </div>

</div>

<footer>
  Model: best.onnx &nbsp;·&nbsp; Powered by ONNX Runtime Web &nbsp;·&nbsp;
  <a href="https://github.com/Lian-Cunanan/cane-toad-detector" style="color:#444">GitHub</a>
</footer>

<script>
'use strict';

// ---------------------------------------------------------------------------
// Config
// ---------------------------------------------------------------------------
const MODEL_URL      = './best.onnx';
const NAMES_URL      = './class_names.json';
const MODEL_SIZE     = 640;
const CONF_THRESHOLD = 0.50;
const IOU_THRESHOLD  = 0.45;
const BOX_COLOR      = '#00dc5a';
const BOX_WIDTH      = 2;

// ---------------------------------------------------------------------------
// Globals
// ---------------------------------------------------------------------------
let session     = null;
let classNames  = {};
let isRunning   = false;
let lastFpsTime = performance.now();
let frameCount  = 0;
let currentFps  = 0;

const video     = document.getElementById('video');
const canvas    = document.getElementById('canvas');
const ctx       = canvas.getContext('2d');
const overlay   = document.getElementById('overlay');
const overlayMsg= document.getElementById('overlay-msg');
const overlayErr= document.getElementById('overlay-err');

// ---------------------------------------------------------------------------
// Utilities
// ---------------------------------------------------------------------------
function setOverlay(msg, err = '') {
  overlayMsg.textContent = msg;
  overlayErr.textContent = err;
}

function hideOverlay() {
  overlay.classList.add('hidden');
}

// ---------------------------------------------------------------------------
// Preprocessing — video frame → Float32 NCHW tensor [1, 3, 640, 640]
// ---------------------------------------------------------------------------
const offscreen    = document.createElement('canvas');
offscreen.width    = MODEL_SIZE;
offscreen.height   = MODEL_SIZE;
const offscreenCtx = offscreen.getContext('2d');

function preprocess() {
  offscreenCtx.drawImage(video, 0, 0, MODEL_SIZE, MODEL_SIZE);
  const { data } = offscreenCtx.getImageData(0, 0, MODEL_SIZE, MODEL_SIZE);
  const pixels    = MODEL_SIZE * MODEL_SIZE;
  const float32   = new Float32Array(3 * pixels);

  for (let i = 0; i < pixels; i++) {
    float32[i]             = data[i * 4]     / 255.0; // R
    float32[pixels + i]    = data[i * 4 + 1] / 255.0; // G
    float32[2 * pixels + i]= data[i * 4 + 2] / 255.0; // B
  }
  return new ort.Tensor('float32', float32, [1, 3, MODEL_SIZE, MODEL_SIZE]);
}

// ---------------------------------------------------------------------------
// Postprocessing — decode YOLOv8 output [1, nc+4, 8400]
// ---------------------------------------------------------------------------
function postprocess(outputData, numClasses, origW, origH) {
  const anchors = 8400;
  const dets    = [];

  for (let j = 0; j < anchors; j++) {
    // Find best class
    let maxScore = 0;
    let maxClass = 0;
    for (let c = 0; c < numClasses; c++) {
      const s = outputData[(4 + c) * anchors + j];
      if (s > maxScore) { maxScore = s; maxClass = c; }
    }

    if (maxScore < CONF_THRESHOLD) continue;

    // cx, cy, w, h → x1, y1, x2, y2  (scaled to original video size)
    const cx = outputData[0 * anchors + j];
    const cy = outputData[1 * anchors + j];
    const w  = outputData[2 * anchors + j];
    const h  = outputData[3 * anchors + j];

    dets.push({
      x1:      (cx - w / 2) / MODEL_SIZE * origW,
      y1:      (cy - h / 2) / MODEL_SIZE * origH,
      x2:      (cx + w / 2) / MODEL_SIZE * origW,
      y2:      (cy + h / 2) / MODEL_SIZE * origH,
      score:   maxScore,
      classId: maxClass,
    });
  }

  dets.sort((a, b) => b.score - a.score);
  return nms(dets);
}

function iou(a, b) {
  const ix1 = Math.max(a.x1, b.x1), iy1 = Math.max(a.y1, b.y1);
  const ix2 = Math.min(a.x2, b.x2), iy2 = Math.min(a.y2, b.y2);
  const inter = Math.max(0, ix2 - ix1) * Math.max(0, iy2 - iy1);
  if (inter === 0) return 0;
  const aArea = (a.x2 - a.x1) * (a.y2 - a.y1);
  const bArea = (b.x2 - b.x1) * (b.y2 - b.y1);
  return inter / (aArea + bArea - inter);
}

function nms(dets) {
  const keep = [];
  const skip = new Set();
  for (let i = 0; i < dets.length; i++) {
    if (skip.has(i)) continue;
    keep.push(dets[i]);
    for (let j = i + 1; j < dets.length; j++) {
      if (!skip.has(j) && dets[i].classId === dets[j].classId && iou(dets[i], dets[j]) > IOU_THRESHOLD)
        skip.add(j);
    }
  }
  return keep;
}

// ---------------------------------------------------------------------------
// Drawing
// ---------------------------------------------------------------------------
function drawDetections(dets) {
  const cw = canvas.width;
  const ch = canvas.height;

  ctx.clearRect(0, 0, cw, ch);

  // FPS overlay
  ctx.fillStyle = '#00c8ff';
  ctx.font = 'bold 14px Segoe UI, Arial';
  ctx.fillText(`FPS: ${currentFps.toFixed(1)}`, 10, 22);

  for (const d of dets) {
    const label = `${classNames[d.classId] ?? d.classId}: ${(d.score * 100).toFixed(1)}%`;

    ctx.strokeStyle = BOX_COLOR;
    ctx.lineWidth   = BOX_WIDTH;
    ctx.strokeRect(d.x1, d.y1, d.x2 - d.x1, d.y2 - d.y1);

    // Label background
    ctx.font = 'bold 13px Segoe UI, Arial';
    const tw = ctx.measureText(label).width;
    const th = 18;
    ctx.fillStyle = BOX_COLOR;
    ctx.fillRect(d.x1, d.y1 - th - 2, tw + 8, th + 2);

    // Label text
    ctx.fillStyle = '#000';
    ctx.fillText(label, d.x1 + 4, d.y1 - 4);
  }
}

// ---------------------------------------------------------------------------
// Sidebar update
// ---------------------------------------------------------------------------
function updateSidebar(dets) {
  document.getElementById('det-count').innerHTML =
    `${dets.length} <small>detected this frame</small>`;
  document.getElementById('det-val').textContent = dets.length;
  document.getElementById('fps-val').textContent = currentFps.toFixed(1);

  const list = document.getElementById('det-list');
  if (dets.length === 0) {
    list.innerHTML = '<p class="none-msg">No detections...</p>';
    return;
  }

  list.innerHTML = dets.map(d => {
    const name = classNames[d.classId] ?? `class ${d.classId}`;
    const pct  = (d.score * 100).toFixed(1);
    return `
      <div class="det-card">
        <div class="lbl">${name}</div>
        <div class="conf">Confidence: ${pct}%</div>
        <div class="bar-bg"><div class="bar-fill" style="width:${pct}%"></div></div>
        <div class="bbox">bbox [${[d.x1,d.y1,d.x2,d.y2].map(v=>Math.round(v)).join(', ')}]</div>
      </div>`;
  }).join('');
}

// ---------------------------------------------------------------------------
// Detection loop
// ---------------------------------------------------------------------------
async function detect() {
  if (!isRunning || video.readyState < 2) {
    requestAnimationFrame(detect);
    return;
  }

  // Sync canvas size to displayed video size
  if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
  }

  // FPS counter
  frameCount++;
  const now = performance.now();
  if (now - lastFpsTime >= 1000) {
    currentFps  = frameCount / ((now - lastFpsTime) / 1000);
    frameCount  = 0;
    lastFpsTime = now;
  }

  try {
    const inputTensor = preprocess();
    const feeds       = { [session.inputNames[0]]: inputTensor };
    const results     = await session.run(feeds);
    const outData     = results[session.outputNames[0]].data;
    const numClasses  = Object.keys(classNames).length;

    const dets = postprocess(outData, numClasses, video.videoWidth, video.videoHeight);
    drawDetections(dets);
    updateSidebar(dets);

  } catch (e) {
    console.error('Inference error:', e);
  }

  requestAnimationFrame(detect);
}

// ---------------------------------------------------------------------------
// Startup
// ---------------------------------------------------------------------------
async function init() {
  try {
    // 1. Load class names
    setOverlay('Loading class names...');
    const namesResp = await fetch(NAMES_URL);
    if (!namesResp.ok) throw new Error(`Could not load class_names.json (${namesResp.status})`);
    classNames = await namesResp.json();
    console.log('[INFO] Class names:', classNames);

    // 2. Load ONNX model
    setOverlay('Loading ONNX model (may take ~30s on first visit)...');
    ort.env.wasm.numThreads = 1; // Safe default for all browsers
    session = await ort.InferenceSession.create(MODEL_URL, {
      executionProviders: ['wasm'],
    });
    console.log('[INFO] Model inputs:',  session.inputNames);
    console.log('[INFO] Model outputs:', session.outputNames);

    // 3. Start webcam
    setOverlay('Starting webcam...');
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'environment' },
      audio: false,
    });
    video.srcObject = stream;
    await video.play();

    canvas.width  = video.videoWidth  || 640;
    canvas.height = video.videoHeight || 480;

    isRunning = true;
    hideOverlay();

    // 4. Start detection loop
    requestAnimationFrame(detect);

  } catch (err) {
    console.error(err);
    document.querySelector('.spinner').style.display = 'none';
    setOverlay('Failed to start.', err.message || String(err));
  }
}

init();
</script>
</body>
</html>
